<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Inventory Management</title>
<style>
body {margin:0;font-family:"Segoe UI",Roboto;background:#f5f6f7;}
.header {height:56px;background:#0b5cab;color:#fff;display:flex;align-items:center;padding:0 20px;font-weight:600;}
.container {display:flex;height:calc(100vh - 56px);}
.sidebar {width:240px;background:#1f2937;color:#d1d5db;}
.sidebar a {display:block;padding:12px 20px;color:#d1d5db;text-decoration:none;}
.sidebar a:hover {background:#374151;}
.main {flex:1;padding:20px;overflow:auto;}
.card {background:#fff;padding:20px;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,.1);}
button {background:#0b5cab;color:#fff;border:none;padding:8px 14px;border-radius:4px;cursor:pointer;}
button.secondary {background:#6b7280;}
button.danger {background:#b91c1c;}
table {width:100%;border-collapse:collapse;margin-top:15px;}
th,td {padding:10px;border-bottom:1px solid #e5e7eb;}
th {background:#f9fafb;}
.modal {position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;}
.modal-content {background:#fff;padding:20px;width:420px;border-radius:6px;}
input {width:100%;padding:8px;margin:6px 0;border:1px solid #d1d5db;border-radius:4px;}
</style>
</head>
<body>

<div class="header">Inventory Management</div>

<div class="container">
  <div class="sidebar">
    <a onclick="showInventory()">Products</a>
    <a onclick="showReports()">Reports</a>
    <a onclick="logout()">Logout</a>
  </div>
  <div class="main" id="content"></div>
</div>

<!-- CREATE ITEM MODAL -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>Create Item</h3>
    <input id="name" placeholder="Item Name">
    <input id="model" placeholder="Model">
    <input id="cost" type="number" placeholder="Cost">
    <input id="qty" type="number" placeholder="Quantity">
    <button onclick="addItem()">Create</button>
    <button class="secondary" onclick="closeModal()">Cancel</button>
  </div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://xxmaogasxtmpjghevuxy.supabase.co'
const supabaseKey = 'process.env.SUPABASE_KEY' // replace with your anon key
const supabase = createClient(supabaseUrl, supabaseKey)

let currentAsset = null

// Check login
const supabaseUser = JSON.parse(sessionStorage.getItem('supabase_user'))
if (!supabaseUser) window.location.href = 'login.html'

// ============================
// FUNCTIONS
// ============================

async function fetchInventory() {
  const { data, error } = await supabase.from('inventory').select('*')
  if (error) { console.error(error); return [] }
  return data
}

async function fetchAudit(itemName) {
  const { data, error } = await supabase
    .from('audit_logs')
    .select('*')
    .eq('item_name', itemName)
    .order('created_at', { ascending: false })
  if (error) { console.error(error); return [] }
  return data
}

async function log(action, itemName) {
  await supabase.from('audit_logs').insert([{
    item_name: itemName,
    action,
    user_email: supabaseUser.email
  }])
}

async function showInventory() {
  const inventory = await fetchInventory()
  content.innerHTML = `
    <div class="card">
      <h2>Products Dashboard</h2>
      <button onclick="openModal()">➕ Create Item</button>
      <button class="secondary" onclick="exportCSV('inventory')">Export CSV</button>

      <table>
        <tr><th>Name</th><th>Model</th><th>Qty</th><th>Cost</th><th>Value</th></tr>
        ${inventory.map((i,n)=>`
          <tr onclick="openRecord(${i.id})">
            <td>${i.name}</td>
            <td>${i.model}</td>
            <td>${i.qty}</td>
            <td>$${i.cost}</td>
            <td>$${(i.qty*i.cost).toFixed(2)}</td>
          </tr>
        `).join('')}
      </table>
    </div>
  `
}

async function openRecord(id) {
  const { data: p, error } = await supabase.from('inventory').select('*').eq('id', id).single()
  if (error) return console.error(error)
  currentAsset = p

  const audit = await fetchAudit(p.name)

  content.innerHTML = `
    <div class="card">
      <h2>${p.name} (Asset Record)</h2>
      <p><b>Model:</b> ${p.model}</p>
      <p><b>Qty:</b> ${p.qty}</p>
      <p><b>Cost:</b> $${p.cost}</p>
      <p><b>Total Value:</b> $${(p.qty*p.cost).toFixed(2)}</p>

      <h3>Audit History</h3>
      ${audit.map(a=>`<div>${a.created_at} — ${a.action} — ${a.user_email}</div>`).join('')}
      <br>
      <button onclick="showInventory()">Back</button>
      ${supabaseUser.role === 'admin'
        ? `<button class="danger" onclick="deleteCurrentAsset()">Delete Asset</button>`
        : `<p><i>You do not have permission to delete assets.</i></p>`}
    </div>
  `
}

async function addItem() {
  const nameEl = document.getElementById('name')
  const modelEl = document.getElementById('model')
  const costEl = document.getElementById('cost')
  const qtyEl = document.getElementById('qty')

  const { data, error } = await supabase.from('inventory').insert([{
    name: nameEl.value,
    model: modelEl.value,
    cost: +costEl.value,
    qty: +qtyEl.value,
    created_by: supabaseUser.id
  }])

  if (error) return alert(error.message)
  await log('CREATE ITEM', nameEl.value)

  closeModal()
  showInventory()
}

async function deleteCurrentAsset() {
  if (!currentAsset) return
  if (!confirm(`Are you sure you want to delete "${currentAsset.name}"?`)) return

  const { error } = await supabase.from('inventory').delete().eq('id', currentAsset.id)
  if (error) return alert(error.message)

  await log('DELETE ASSET', currentAsset.name)
  currentAsset = null
  showInventory()
}

function openModal(){ modal.style.display='flex' }
function closeModal(){ modal.style.display='none' }

async function showReports() {
  const { data: audit, error } = await supabase.from('audit_logs').select('*').order('created_at', { ascending:false })
  if (error) return console.error(error)
  const { data: inventoryData } = await supabase.from('inventory').select('*')
  const totalValue = inventoryData.reduce((s,i)=>s+i.qty*i.cost,0).toFixed(2)

  content.innerHTML = `
    <div class="card">
      <h2>Reports & Audit</h2>
      <button onclick="exportCSV('audit')">Export Audit CSV</button>
      <p><b>Total Inventory Value:</b> $${totalValue}</p>
      <h3>Audit Logs</h3>
      ${audit.map(a=>`<div>${a.created_at} — ${a.action} — ${a.user_email}</div>`).join('')}
    </div>
  `
}

function logout() {
  supabase.auth.signOut()
  sessionStorage.clear()
  window.location.href='login.html'
}

async function exportCSV(type) {
  let rows
  if (type==='inventory') {
    const { data } = await supabase.from('inventory').select('*')
    rows = [['Name','Model','Qty','Cost'], ...data.map(i=>[i.name,i.model,i.qty,i.cost])]
  } else {
    const { data } = await supabase.from('audit_logs').select('*')
    rows = [['Time','Action','Item','User'], ...data.map(a=>[a.created_at,a.action,a.item_name,a.user_email])]
  }
  const csv = rows.map(r=>r.join(',')).join('\n')
  const a = document.createElement('a')
  a.href = URL.createObjectURL(new Blob([csv]))
  a.download = type+'.csv'
  a.click()
}

showInventory()
</script>
</body>
</html>
